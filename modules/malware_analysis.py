import os
import sys
import json
import requests
import subprocess
from datetime import datetime
from loguru import logger

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), "..")))
from config.config import CONFIG
from .utils import init_db, store_result, save_output
from core.output_formatter import OutputFormatter

logger.add("logs/phantomwatch.log", rotation="10MB", level="INFO", format="{time} | {level} | {message}")
logger.add("logs/error.log", rotation="10MB", level="ERROR", format="{time} | {level} | {message}")


# Initialize database
init_db()

# API Keys
ANYRUN_API_KEY = CONFIG.get("ANYRUN_API_KEY", "")
HYBRIDANALYSIS_API_KEY = CONFIG.get("HYBRIDANALYSIS_API_KEY", "")
OUTPUT_FILE = CONFIG.get("MALWARE_REPORT", "../output/malware_analysis.json")

def run_static_analysis(file_path):
    """Perform static analysis on a malware sample."""
    if not os.path.exists(file_path):
        OutputFormatter.log_message(f"File {file_path} not found!", "error")
        return {}
    
    try:
        result = subprocess.run(
            ["strings", file_path], capture_output=True, text=True
        )
        strings_output = result.stdout.split("\n")

        metadata = {
            "file": file_path,
            "timestamp": datetime.now().isoformat(),
            "ioc": strings_output[:50]  # Extract first 50 strings as potential IOCs
        }
        store_result("malware_analysis", file_path, "static_analysis")
        OutputFormatter.log_message(f"Static analysis completed for {file_path}", "info")
        return metadata
    except Exception as e:
        OutputFormatter.log_message(f"Static analysis failed: {e}", "error")
        return {}


def run_dynamic_analysis(file_path):
    ANYRUN_API_URL = CONFIG.get("ANYRUN_API_URL")
    """Send the malware sample to ANY.RUN sandbox for analysis."""
    if not ANYRUN_API_KEY:
        OutputFormatter.log_message("ANY.RUN API key is missing.", "error")
        return {}
    
    try:
        url = f"{ANYRUN_API_URL}/file_path"
        headers = {"Authorization": f"Bearer {ANYRUN_API_KEY}"}
        files = {"file": open(file_path, "rb")}
        response = requests.post(url, headers=headers, files=files)
        
        if response.status_code == 200:
            result = response.json()
            OutputFormatter.log_message(f"Dynamic analysis submitted for {file_path}", "info")
            return result
        else:
            OutputFormatter.log_message(f"ANY.RUN submission failed: {response.text}", "error")
            return {}
    except Exception as e:
        OutputFormatter.log_message(f"Dynamic analysis error: {e}", "error")
        return {}


def fetch_threat_intelligence(hash_value):
    HYBRIDANALYSIS_API_URL = CONFIG.get("HYBRIDANALYSIS_API_URL")
    """Fetch additional intelligence from HybridAnalysis."""
    if not HYBRIDANALYSIS_API_KEY:
        OutputFormatter.log_message("HybridAnalysis API key is missing.", "error")
        return {}
    
    try:
        url = f"{HYBRIDANALYSIS_API_URL}/{hash_value}"
        headers = {"api-key": HYBRIDANALYSIS_API_KEY, "User-Agent": "Falcon"}
        response = requests.get(url, headers=headers)
        
        if response.status_code == 200:
            OutputFormatter.log_message(f"Threat intelligence retrieved for hash {hash_value}")
            return response.json()
        else:
            OutputFormatter.log_message(f"HybridAnalysis request failed: {response.text}", "error")
            return {}
    except Exception as e:
        OutputFormatter.log_message(f"Threat intelligence error: {e}", "error")
        return {}

def run(sample_file):
    """Executes malware analysis on a given sample file."""
    
    if not sample_file or not os.path.isfile(sample_file):
        OutputFormatter.print_message(f"[-] Error: Invalid or missing sample file '{sample_file}'.", "error")
        return

    OutputFormatter.print_message(f"[+] Analyzing malware sample: {sample_file}", "info")

    try:
        static_results = run_static_analysis(sample_file) or {}
        dynamic_results = run_dynamic_analysis(sample_file) or {}

        hash_value = static_results.get("hash", "")
        threat_intel = fetch_threat_intelligence(hash_value) if hash_value else {}

        final_results = {
            "static_analysis": static_results,
            "dynamic_analysis": dynamic_results,
            "threat_intelligence": threat_intel
        }
        
        save_output(final_results, OUTPUT_FILE)
        store_result("malware_analysis", sample_file, "analysis_completed")

        OutputFormatter.print_message("[+] Malware analysis completed successfully.", "success")

    except Exception as e:
        OutputFormatter.print_message(f"[-] Error during analysis: {e}", "error")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        OutputFormatter.print_message("Usage: python -m modules.malware_analysis <sample_file>", "error")
        sys.exit(1)

    sample_file = sys.argv[1]  # Get malware sample path from CLI
    run(sample_file)
